//***********************************************************************************
//Universidad del Valle de Guatemala
//BE3029 - Electrónica Digital 2
//Dulce Nicole Monney Paiz, 21549
//Laboratorio 8 - Manejo de memoria SD
//***********************************************************************************

//Librerías
#include <SD.h>
//***********************************************************************************

//Definición de pines
#define CS_PIN 5 // CS_PIN 5
//***********************************************************************************

//Variables globales 
File root;
//***********************************************************************************

//Prototipos de funciones
void printDirectory(File dir, int numTabs) {
  while (true) {
    File entry = dir.openNextFile();
    if (!entry) {
      // no more files
      break;
    }
    for (uint8_t i = 0; i < numTabs; i++) {
      Serial.print('\t');
    }
    Serial.print(entry.name());
    if (entry.isDirectory()) {
      Serial.println("/");
      printDirectory(entry, numTabs + 1);
    } else {
      // files have sizes, directories do not
      Serial.print("\t\t");
      Serial.println(entry.size(), DEC);
    }
    entry.close();
  }
}

void showMenu() {
  Serial.println("Elige una opción:");
  Serial.println("1. Mostrar imagen 1");
  Serial.println("2. Mostrar imagen 2");
  Serial.println("3. Mostrar imagen 3");
  Serial.println("4. Crear una nueva imagen");
  Serial.println("5. Ver imagen creada");
}

void displayImage(const char* imagePath) {
  File imageFile = SD.open(imagePath);
  if (imageFile) {
    Serial.print(imagePath);
    Serial.println(": ");
    while (imageFile.available()) {
      Serial.write(imageFile.read());
    }
    imageFile.close();
  } else {
    Serial.print("Error al abrir ");
    Serial.println(imagePath);
  }
}

String readLine() { //Lectura que se ingresan al monitor serial
  String received = "";
  char x;
  while (true) {
    if (Serial.available()) {
      x = Serial.read();
      if (x == '\n') {
        break;
      } else {
        received += x;
      }
    }
  }
  return received;
}

void createImage() {
  String imageData;
  String imageName;
  imageName = "holasoynuevo";
/*
  Serial.println("Por favor, proporciona un nombre para la imagen (sin extensión):");
   while (true) {
    imageName = readLine();
    if (imageName != "") {
      break;
    }
  } 
*/
  Serial.println("Ahora, ingresa el contenido de la imagen. Cuando hayas terminado, escribe 'FIN' en una nueva línea:");
  while (true) {
    String line = readLine();
    if (line == "FIN") {
      break;
    }
    imageData += line + "\n"; // Añade un salto de línea después de cada línea ingresada.
  }

  // Guardar los datos en la tarjeta SD
  File newImage = SD.open("/" + imageName + ".txt", FILE_WRITE);
  if (newImage) {
    newImage.print(imageData);
    newImage.close();
    Serial.println("Imagen creada y guardada con éxito!");
    displayImage("/holasoynuevo.txt");
  } else {
    Serial.println("Error al guardar la imagen.");
  }
}
//***********************************************************************************

//Configuración
void setup() {
  Serial.begin(115200);

  Serial.print("Initializing SD card... ");

  if (!SD.begin(CS_PIN)) {
    Serial.println("Card initialization failed!");
    while (true);
  }

  Serial.println("initialization done.");

  Serial.println("Files in the card:");
  root = SD.open("/");
  printDirectory(root, 0);
  Serial.println("");

  showMenu();
}
//***********************************************************************************

//Loop principal
void loop() {
  if (Serial.available()) {
    char option = Serial.read();
    switch (option) {
      case '1':
        displayImage("/DINO.txt");
        Serial.println("");
        Serial.println("");
        showMenu();
        break;
      case '2':
        displayImage("/ScottPilgrim.txt");
        Serial.println("");
        Serial.println("");
        showMenu();
        break;
      case '3':
        displayImage("/sleepykirby.txt");
        Serial.println("");
        Serial.println("");
        showMenu();
        break;
      case '4':
        Serial.println("");
        Serial.println("");
        createImage();
        showMenu();
        break;
      case '5':
        displayImage("/holasoynuevo.txt");
        Serial.println("");
        Serial.println("");
        showMenu();
        break;
      default:
        showMenu();
        break;
    }
  }
}
//***********************************************************************************
